<!doctype html>
<html>

<head>
    <meta name=viewport content='width=device-width,initial-scale=1'>
    <title>Quadcopter data</title>
    <style>
        body {
            font-family: system-ui;
            margin: 16px
        }

        .v {
            font-family: monospace
        }
    </style>
</head>

<body>
    <h2>Yaw/Pitch/Roll + Keys + PWM</h2>
    <p>Press <b>WASD</b>, <b>IJKL</b>, <b>TFGH</b> to send packets. Press <b>T</b> to ZERO (avg last 20).</p>
    <div class=v id=ypr>yaw=0 pitch=0 roll=0</div>
    <div class=v id=pwm>mot1=0 mot2=0 mot3=0 mot4=0</div>
    <div class=v id=state></div>


    <script>
        let ws; let wasd = 0, ijkl = 0, tfgh = 0; let sentZero = false;
        const keyBit = {
            'w': ['wasd', 0], 'a': ['wasd', 1], 's': ['wasd', 2], 'd': ['wasd', 3],
            'i': ['ijkl', 0], 'j': ['ijkl', 1], 'k': ['ijkl', 2], 'l': ['ijkl', 3],
            't': ['tfgh', 0], 'f': ['tfgh', 1], 'g': ['tfgh', 2], 'h': ['tfgh', 3]
        };

        function hx(n) { 
            return n.toString(16).toUpperCase(); 
        }

        function pkt() { 
            return `P:${hx(wasd)}${hx(ijkl)}${hx(tfgh)}`; 
        }

        function send() { 
            if (ws && ws.readyState === 1) 
            ws.send(pkt()); 
        }

        function up() { 
            document.getElementById('state').textContent = `WASD=0x${hx(wasd)} IJKL=0x${hx(ijkl)} TFGH=0x${hx(tfgh)}`; 
        }

        addEventListener('keydown', e => {
            const k = e.key.toLowerCase();
            if (k === 't' && !sentZero) { sentZero = true; zero(); }
            if (keyBit[k]) {
                let s = keyBit[k][0], b = keyBit[k][1];
                if (s === 'wasd') wasd |= (1 << b); else if (s === 'ijkl') ijkl |= (1 << b); else tfgh |= (1 << b);
                send(); up();
            }
        });

        addEventListener('keyup', e => {
            const k = e.key.toLowerCase();
            if (k === 't') sentZero = false;
            if (keyBit[k]) {
                let s = keyBit[k][0], b = keyBit[k][1];
                if (s === 'wasd') wasd &= ~(1 << b); else if (s === 'ijkl') ijkl &= ~(1 << b); else tfgh &= ~(1 << b);
                send(); up();
            }
        });

        function connect() {
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${location.host}/ws`);
            ws.onclose = () => setTimeout(connect, 1000);
        }

        connect();
        setInterval(() => {
            fetch('/imu.json?ts=' + Date.now(), { cache: 'no-store' })
                .then(r => r.json())
                .then(j => {
                    const el = document.getElementById('ypr');
                    if (j && Number.isFinite(j.yaw) && Number.isFinite(j.pitch) && Number.isFinite(j.roll)) {
                        el.textContent = `yaw=${j.yaw.toFixed(2)} pitch=${j.pitch.toFixed(2)} roll=${j.roll.toFixed(2)}`;
                    } else {
                        el.textContent = 'no data yet…';
                    }
                })
                .catch(() => {
                    document.getElementById('ypr').textContent = 'fetch failed…';
                });
        }, 250);

        setInterval(() => {
            fetch('/pwm.json?ts=' + Date.now(), { cache: 'no-store'})
            .then(r => r.json())
            .then(j =>{
                const el = document.getElementById('pwm');
                if (j && Number.isFinite(j.mot1) && Number.isFinite(j.mot2) && Number.isFinite(j.mot3) && Number.isFinite(j.mot4)) {
                    el.textContent = `mot1=${j.mot1.toFixed(2)} mot2=${j.mot2.toFixed(2)} mot3=${j.mot3.toFixed(2)} mot4=${j.mot4.toFixed(2)}`;
                } else {
                    el.textContent = 'no data yet…';
                }
            })
            .catch(() => {
                document.getElementById('pwm').textContent = 'fetch failed';
            });
        }, 250);
    </script>
</body>

</html>